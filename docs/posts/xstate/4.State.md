# State

## State Object

State = çŠ¶æ€æœºåœ¨æŸä¸€æ—¶åˆ»çš„â€œå®Œæ•´å¿«ç…§ï¼ˆsnapshotï¼‰â€ã€‚å®ƒä¸æ˜¯åªæœ‰ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè€Œæ˜¯ä¸€ä¸ª**å¯¹è±¡**ï¼ŒåŒ…å«äº†ï¼š

```ts
{
  value,     // å½“å‰å¤„äºå“ªäº›çŠ¶æ€
  context,   // æ‰©å±•çŠ¶æ€ï¼ˆä¸šåŠ¡æ•°æ®ï¼‰
  meta,      // çŠ¶æ€å…ƒä¿¡æ¯
  children,  // å½“å‰æ´»è·ƒçš„å­ actor
  status,    // active | done | stopped
  output     // ç»“æŸæ€è¾“å‡ºï¼ˆå¦‚æœæœ‰ï¼‰
}

```

stateæ˜¯ä¸€ä¸ªåªè¯»çš„ï¼Œå¯ä¿¡çš„UIçŠ¶æ€æº

```ts
const feedbackMachine = createMachine({
  id: 'feedback',
  initial: 'question',
  context: {
    feedback: '',
  },
  states: {
    question: {
      meta: {
        question: 'How was your experience?',
      },
    },
  },
});

const actor = createActor(feedbackMachine);
actor.start();

console.log(actor.getSnapshot());
// Logs an object containing:
// {
//   value: 'question',
//   context: {
//     feedback: ''
//   },
//   meta: {
//     'feedback.question': {
//       question: 'How was your experience?'
//     }
//   }
// }
```

## value

- ç®€å•çŠ¶æ€æœºï¼š

```ts
state.value === 'question'
```

- åµŒå¥—çŠ¶æ€æœº

```ts
state.value === { form: 'invalid' }
```

å½“å‰çŠ¶æ€æœºä¸­ï¼š

æ¿€æ´»äº†ä¸€ä¸ªçˆ¶çŠ¶æ€ **`form`**ï¼Œå¹¶ä¸”åœ¨ `form` é‡Œé¢ï¼Œæ¿€æ´»çš„å­çŠ¶æ€æ˜¯ **`invalid`**

```ts
createMachine({
  initial: 'form',
  states: {
    form: {
      initial: 'invalid',
      states: {
        invalid: {},
        valid: {},
      },
    },
  },
})

```

::: tip ä¸ºä»€ä¹ˆä¸æ˜¯ `'invalid'`ï¼Œè€Œæ˜¯ `{ form: 'invalid' }`ï¼Ÿ

å› ä¸º **XState ä¸ä¼šä¸¢å¤±â€œå±‚çº§ä¿¡æ¯â€**ã€‚

:::

- å¹¶è¡ŒçŠ¶æ€

æ¯ä¸ª key = ä¸€ä¸ªå¹¶è¡ŒåŒºåŸŸ

```ts
state.value ===
  {
    monitor: 'on',
    mode: 'dark',
  };
```

```ts
createMachine({
  type: 'parallel', // ğŸ‘ˆ å…³é”®
  states: {
    playback: {
      initial: 'paused',
      states: {
        paused: {},
        playing: {},
      },
    },
    volume: {
      initial: 'unmuted',
      states: {
        muted: {},
        unmuted: {},
      },
    },
  },
})
```

äº‹ä»¶å¦‚ä½•ä½œç”¨åœ¨å¹¶è¡ŒçŠ¶æ€ä¸Šï¼š

```ts
on: {
  PLAY: { target: '.playback.playing' },
  MUTE: { target: '.volume.muted' },
}
```



- null

State machines may also have no state nodes other than the root state node. For these state machines, the state value is `null`.

## context

`state.context` è¡¨ç¤ºçš„æ˜¯å½“å‰çŠ¶æ€ä¸‹çš„ä¸Šä¸‹æ–‡ã€‚

```ts
const state = actor.getSnapshot()

state.context
// => { count: 0 }

```



```ts
createMachine({
  context: {
    count: 0,
  },
  initial: 'a',
  states: {
    a: {
      on: {
        NEXT: {
          target: 'b',
          actions: assign({
            count: ({ context }) => context.count + 1,
          }),
        },
      },
    },
    b: {
      entry: ({ context }) => {
        console.log(context.count)
      },
    },
  },
})

```

ä½ æ‹¿åˆ°çš„æ˜¯â€œå¿«ç…§ï¼ˆsnapshotï¼‰â€ï¼Œä¸æ˜¯â€œçŠ¶æ€æœ¬ä½“â€

```ts
const state = actor.getSnapshot()

/*
{
  value: ...,
  context: { count: 1 },
  ...
}
*/

```

è¿™ä¸ªå¯¹è±¡æ˜¯ï¼š

- âœ… å½“å‰æ—¶åˆ»çš„**åªè¯»å¿«ç…§**

- âŒ ä¸æ˜¯çŠ¶æ€æœºå†…éƒ¨æ­£åœ¨ç”¨çš„é‚£ä¸€ä»½

```ts
state.context.count++ // âŒ
```



## children

`state.children` æ˜¯â€œå½“å‰çŠ¶æ€æœºæ­£åœ¨è¿è¡Œçš„æ‰€æœ‰å­ actor çš„ç´¢å¼•è¡¨â€

key = actor id

value = ActorRef



## tags

**tag æ˜¯ä½ ç»™â€œçŠ¶æ€èŠ‚ç‚¹â€è´´çš„è¯­ä¹‰æ ‡ç­¾**ï¼Œå’Œå±‚çº§ã€åå­—æ— å…³ï¼Œåªè¡¨è¾¾â€œè¿™ä¸ªçŠ¶æ€å±äºå“ªä¸€ç±»â€ã€‚

```ts
const feedbackMachine = createMachine({
  // ...
  states: {
    submitting: {
      tags: ['loading'],
      // ...
    },
  },
});

const feedbackActor = createActor(feedbackMachine).start();

const currentState = feedbackActor.getSnapshot();

const showLoadingSpinner = currentState.hasTag('loading');
```

## descriptions

 **State descriptionsï¼ˆçŠ¶æ€æè¿°ï¼‰**ã€‚å®ƒ**ä¸å½±å“çŠ¶æ€æœºè¿è¡Œ**ï¼Œä½†å¯¹**åä½œã€å¯ç»´æŠ¤æ€§ã€å¯è§†åŒ–**éå¸¸é‡è¦ã€‚

State descriptions æ˜¯å†™ç»™â€œäººâ€çœ‹çš„è¯´æ˜æ–‡å­—ï¼Œç”¨æ¥è§£é‡Šâ€œè¿™ä¸ªçŠ¶æ€æ˜¯å¹²å˜›çš„â€ã€‚

- ç”¨äºæ–‡æ¡£ã€åä½œã€å¯è§†åŒ–ï¼ˆå°¤å…¶æ˜¯ Stately Studioï¼‰

```ts
states: {
  "Loading Move Destinations": {
    description:
      "Load data from the server based on the entity's id and type (project or machine). Result includes the entity's current location, and the list or tree of valid destination options to which the user may move that entity.",
    invoke: {
      src: "loadMoveData",
      id: "loadMoveData",
      onDone: [
        {
          target: "Destination Menu",
          actions: "setDestinations",
        },
      ],
      onError: [
        {
          target: "Data Loading Error",
        },
      ],
    },
  },
}
```



## methods

### state.can(event)

```ts
state.can(event:EventObject)
```

- eventï¼šEventObjectã€‚äº‹ä»¶å¯¹è±¡

`state.can(event)` ç”¨æ¥åˆ¤æ–­ï¼šåœ¨â€œå½“å‰çŠ¶æ€ + å½“å‰ä¸Šä¸‹æ–‡â€ä¸‹ï¼Œå‘é€è¿™ä¸ªäº‹ä»¶ä¼šä¸ä¼šè§¦å‘ä¸€æ¬¡çŠ¶æ€è½¬æ¢ã€‚`state.can` ä¼šçœŸå®æ‰§è¡Œ guard

```ts
const machine = createMachine({
  context: { valid: false },
  initial: 'form',
  states: {
    form: {
      on: {
        SUBMIT: {
          target: 'success',
          guard: ({ context }) => context.valid
        }
      }
    },
    success: {}
  }
})

const actor = createActor(machine).start()
const state = actor.getSnapshot()

state.can({ type: 'SUBMIT' }) // falseï¼ˆguard ä¸é€šè¿‡ï¼‰

```

### state.hasTag(tag)

`state.hasTag(tag)` ç”¨æ¥åˆ¤æ–­ï¼šå½“å‰æ¿€æ´»çš„ä»»æ„çŠ¶æ€èŠ‚ç‚¹ï¼Œæ˜¯å¦æ‰“äº†æŸä¸ª tagã€‚

```ts
state.hasTag(tag:string)
```



### state.matches(value)

```ts
state.matches(value)
```

- valueï¼šStateValueã€‚çŠ¶æ€å€¼

`state.matches(...)` ç”¨æ¥åˆ¤æ–­ï¼šå½“å‰ `state.value` æ˜¯å¦â€œåŒ…å«â€ä½ ç»™å®šçš„çŠ¶æ€è·¯å¾„ã€‚åªè¦å½“å‰çŠ¶æ€â€œåŒ…å«â€ä½ ç»™çš„è·¯å¾„ï¼Œå°±ç®—åŒ¹é…

```ts
// state.value === 'question'
state.matches('question'); // true

// state.value === { form: 'invalid' }
state.matches('form'); // true
state.matches('question'); // false
state.matches({ form: 'invalid' }); // true
state.matches({ form: 'valid' }); // false

```

### state.output

çŠ¶æ€æœºâ€œèµ°åˆ°æœ€ç»ˆå®Œæˆæ€ï¼ˆfinalï¼‰æ—¶â€ï¼Œå¯¹å¤–äº§å‡ºçš„ç»“æœã€‚

å¿…é¡» **åŒæ—¶æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶**ï¼š

1. çŠ¶æ€æœºåˆ°è¾¾ **é¡¶å±‚ final state**
2. final state å®šä¹‰äº† `output`

```ts
const machine = createMachine({
  initial: 'loading',
  states: {
    loading: {
      on: {
        DONE: 'success'
      }
    },
    success: {
      type: 'final',
      output: { ok: true }
    }
  }
})
```

```ts
const actor = createActor(machine).start()

actor.send({ type: 'DONE' })

const state = actor.getSnapshot()

state.status // 'done'
state.output // { ok: true }

```



### state.getMeta()

`state.getMeta()` è¿”å›çš„æ˜¯ï¼šå½“å‰â€œæ‰€æœ‰æ¿€æ´»çŠ¶æ€èŠ‚ç‚¹â€çš„ meta ä¿¡æ¯é›†åˆã€‚ä¸æ˜¯æŸä¸€ä¸ª state çš„ metaï¼Œè€Œæ˜¯**æ•´æ£µæ¿€æ´»çŠ¶æ€æ ‘ä¸Šçš„ meta**ã€‚

- Returnï¼š`Record<string, any>`ï¼Œkeyï¼šçŠ¶æ€èŠ‚ç‚¹çš„å®Œæ•´ IDï¼ˆè·¯å¾„ï¼‰

```ts
const feedbackMachine = createMachine({
  id: 'feedback',
  // ...
  states: {
    form: {
      meta: {
        view: 'shortForm',
      },
    },
  },
});

const feedbackActor = createActor(feedbackMachine).start();

// Assume the current state is 'form'
const snapshot = feedbackActor.getSnapshot();
console.log(snapshot.getMeta());
// logs { 'feedback.form': { view:'shortForm' } }
```

é¡µé¢æ ‡é¢˜ / æ–‡æ¡ˆ/è·¯ç”± / å¸ƒå±€é…ç½®

```ts
meta: {
  layout: 'fullscreen',
  authRequired: true,
  title: 'æäº¤æˆåŠŸ',
}

```



| å¯¹æ¯”         | meta       | context  |
| ------------ | ---------- | -------- |
| æ˜¯å¦å¯å˜     | âŒ ä¸å¯å˜   | âœ… assign |
| ç”Ÿå‘½å‘¨æœŸ     | å®šä¹‰æœŸ     | è¿è¡ŒæœŸ   |
| ä½œç”¨         | æè¿°çŠ¶æ€   | ä¿å­˜æ•°æ® |
| æ˜¯å¦å‚ä¸é€»è¾‘ | âŒ          | âœ…        |
| UI é…ç½®      | âœ… éå¸¸é€‚åˆ | âŒ ä¸æ¨è |

