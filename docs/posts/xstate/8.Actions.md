# Actions

Actions æ˜¯â€œè§¦å‘åŽå°±æ‰§è¡Œã€ä¸å…³å¿ƒè¿”å›žç»“æžœçš„å‰¯ä½œç”¨â€

å½“**çŠ¶æ€æœºå‘ç”Ÿ transition** æ—¶ï¼Œå¯èƒ½ä¼šæ‰§è¡Œ actionsã€‚

## ä»€ä¹ˆæ—¶å€™æ‰§è¡Œactions

äº‹ä»¶è§¦å‘ â†’ çŠ¶æ€åˆ‡æ¢ â†’ æ‰§è¡Œ actions

### transition

```ts
on: {
  EVENT: {
    target: 'next',
    actions: [...]
  }
}
```

### entry

åªè¦è¿›å…¥è¯¥çŠ¶æ€ï¼Œå°±ä¼šæ‰§è¡Œ

```ts
entry: [...]
```



### exit

åªè¦ç¦»å¼€è¯¥çŠ¶æ€ï¼Œå°±ä¼šæ‰§è¡Œ

```ts
exit: [...]
```



### actionsæ‰§è¡Œé¡ºåº

```ts
event  â†’  transition
          â”œâ”€ exit actions
          â”œâ”€ transition actions
          â”œâ”€ entry actions
          â†“
        new state

```

Actions æ˜¯â€œäº‹ä»¶å‘ç”ŸåŽçš„å‰¯ä½œç”¨é’©å­â€ï¼Œå¯ä»¥æŒ‚åœ¨ transitionã€entryã€exit ä¸Šï¼Œä½†ä¸ä¼šå½±å“çŠ¶æ€æµè½¬

## Actionsç‰¹ç‚¹

### Actions å¯ä»¥æ˜¯å•ä¸ªï¼Œä¹Ÿå¯ä»¥æ˜¯æ•°ç»„

```ts
actions: { type: 'track' }
```

```ts
actions: [
  { type: 'track' },
  { type: 'showConfetti' }
]
```

### Actionä¹‹é—´æ²¡æœ‰ä¾èµ–æ€§

- actions æ˜¯æŒ‰æ•°ç»„é¡ºåºè¢«â€œéåŽ†æ‰§è¡Œâ€çš„ï¼Œ

- ä½†æ‰€æœ‰ `assign` å¯¹ `context` çš„ä¿®æ”¹æ˜¯â€œåŒæ—¶ç”Ÿæ•ˆâ€çš„

- action ä¹‹é—´ä¸ä¼šä¾èµ–å½¼æ­¤å·²ç»ä¿®æ”¹è¿‡çš„ context

### Action ä¸èƒ½æ˜¯å¼‚æ­¥å‡½æ•°

XState åœ¨å¤„ç† transition æ—¶**ä¸ä¼šç­‰å¾… action å®Œæˆ**

å¼‚æ­¥å‡½æ•°ä¼šè¿”å›ž Promiseï¼Œä½†çŠ¶æ€æœºä¸ä¼šç­‰å¾…å®ƒï¼Œä¹Ÿä¸ä¼šæŠŠå®ƒçº³å…¥çŠ¶æ€æµæŽ§åˆ¶ã€‚

```ts
actions: [
  async ({ context }) => {
    await fetch('/api')
  }
]
```



## Inline actions

å¯ä»¥ç›´æŽ¥åœ¨çŠ¶æ€æœºä¸­å£°æ˜Žactionsã€‚é€‚åˆç®€å•çš„çŠ¶æ€æœº

```ts
callback({context,event})
```

```ts
import { createMachine } from 'xstate';

const feedbackMachine = createMachine({
  entry: [
    // Inline action
    ({ context, event }) => {
      console.log(/* ... */);
    },
  ],
});
```



## Implementing actions

### Action Object

```ts
interface Action{
  type:string
  params:any
}
```

- typeï¼šåœ¨implementationä¸­å®šä¹‰çš„actionå‡½æ•°å
- paramsï¼šä¼ å…¥å‡½æ•°ä¸­çš„å‚æ•°

### å®šä¹‰ Action

```ts
const feedbackMachine = setup({
  actions: {
    track: (_, params: { response: string }) => {
      trackResponse(params.response);
    },
    showConfetti: () => {
      // ...
    }
  }
})

```

- `_`ï¼š `{ context, event, self }`

- `params` ï¼šanyï¼Œ **action è°ƒç”¨æ—¶ä¼ å…¥çš„å‚æ•°**

###  Action ç®€å†™

ä½¿ç”¨è‡ªå®šä¹‰Actionï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š

- string

å¦‚æžœä½ ä¸éœ€è¦ä¼ å‚æ•°ï¼Œå¯ä»¥ä½¿ç”¨å­—ç¬¦ä¸²ç®€å†™

```ts
actions: ['track']
```

```ts
const feedbackMachine = createMachine({
  states: {
    question: {
      on: {
        'feedback.good': {
          actions: ['track'], // âœ… ç®€å†™æ–¹å¼
        },
      },
    },
  },
});

```

- Object

å¦‚æžœä½ éœ€è¦ä¼ å‚æ•°ï¼Œå¯ä»¥ä½¿ç”¨å¯¹è±¡ç®€å†™

```ts
actions: [{ type: 'track', params: {...} }]
```

```ts
actions: [
  { type: 'track', params: { response: 'good' } }
]

```





### åŠ¨æ€actionå‚æ•°

ä¸è¦è®© action ç›´æŽ¥ä¾èµ– context / eventï¼Œè€Œæ˜¯é€šè¿‡ `params` æŠŠéœ€è¦çš„æ•°æ®â€œå–‚â€ç»™å®ƒ

æŽ¨èåšæ³•ï¼š

```ts
params: ({ context }) => ({
  initialRating: context.initialRating,
})

```

```ts
function logInitialRating(_, params: { initialRating: number }) {
  console.log(params.initialRating)
}
```



ä¸æŽ¨èåšæ³•ï¼š

```ts
actions: {
  logInitialRating: ({ context }) => {
    console.log(context.initialRating)
  }
}
```

é—®é¢˜ï¼š

- action **åªèƒ½åœ¨è¿™ä¸ª machine ç”¨**
- æ¢ä¸€ä¸ª context ç»“æž„å°±åºŸäº†
- TS ç±»åž‹ä¼šè¢« machine æ±¡æŸ“

## å†…ç½® actions

:::warning

ä¸èƒ½åœ¨è‡ªå®šä¹‰actionsä¸­è°ƒç”¨å†…ç½®actions

:::

### assign

æ›´æ–° context

```ts
assign({
  count: ({ context }) => context.count + 1
})

```

::: warning å¤šä¸ªaction

å¦‚æžœå­˜åœ¨å¤šä¸ªactionï¼Œå…¶ä¸­ä¸€ä¸ªactionä½¿ç”¨äº†assignæ”¹å˜äº†contextï¼Œä¸‹ä¸€ä¸ªactionä¸­çš„contextå¹¶æ²¡æœ‰æ”¹å˜ã€‚**ä¸‹ä¸€ä¸ªå†…éƒ¨äº‹ä»¶**é‡Œå°†çœ‹åˆ°æ›´æ–°åŽçš„context

```ts
actions: [
  // context.count=1
  assign({
    count: ({ context }) => context.count + 1,
  }),

  // context.count=1
  ({ context }) => {
    if (context.count + 1 >= 3) {
      return raise({ type: 'DONE' });
    }
  },
],

```

:::

- å†™æ³•ä¸€ï¼šå¯¹è±¡å½¢å¼ã€æŽ¨èã€‘

```ts
assign({
  count: ({ context, event }) => context.count + event.value,
})

```

- å†™æ³•äºŒï¼šå‡½æ•°å½¢å¼

```ts
assign(({ context, event }) => {
  return {
    count: context.count + event.value,
  }
})

```



### sendTo

è§¦å‘å…¶ä»–actorçš„äº‹ä»¶

```ts
const machine = createMachine({
  on: {
    note: {
      actions: sendTo('someActor', { type: 'someEvent' }),
    },
  },
});
```



### raise

`raise` å°±æ˜¯â€œåœ¨çŠ¶æ€æœºå†…éƒ¨è§¦å‘ä¸€ä¸ªäº‹ä»¶â€ï¼Œå¹¶ä¸”ä¼šè¢«ç«‹åˆ»å¤„ç†

```ts
raise(EventObject)
```

| å¯¹æ¯”           | `raise`                        | `send / service.send` |
| -------------- | ------------------------------ | --------------------- |
| äº‹ä»¶æ¥æº       | çŠ¶æ€æœºå†…éƒ¨                     | å¤–éƒ¨                  |
| ç›®æ ‡           | å½“å‰çŠ¶æ€æœºè‡ªå·±                 | å½“å‰ / å…¶ä»– actor     |
| å¤„ç†æ—¶æœº       | **å½“å‰ transition ç»“æŸåŽç«‹å³** | ä¸‹ä¸€è½®äº‹ä»¶å¾ªçŽ¯        |
| æ˜¯å¦èƒ½è·¨ actor | âŒ                              | âœ…                     |
| å¸¸ç”¨åœºæ™¯       | å†…éƒ¨æµç¨‹è¡”æŽ¥                   | UI / ç½‘ç»œ / ç”¨æˆ·è¡Œä¸º  |

```ts
INC: {
  actions: [
    assign({ count: ({ context }) => context.count + 1 }),
    raise({ type: 'CHECK' }),//ä¸€æ¬¡ INCï¼Œç«‹åˆ»è¿›å…¥ done
  ],
},
CHECK: {
  guard: ({ context }) => context.count >= 3,
  target: 'done',
},

```



### log

log actionå¯ä»¥æ–¹ä¾¿çš„æ‰“å°æ—¥å¿—åˆ°æŽ§åˆ¶å°

```ts
import { createMachine, log } from 'xstate';

const machine = createMachine({
  on: {
    someEvent: {
      actions: log('some message'),
    },
  },
});
```

### cancel

å–æ¶ˆä¹‹å‰ç”± `sendTo` æˆ– `raise` åˆ›å»ºçš„å»¶è¿Ÿäº‹ä»¶æˆ–å®šæ—¶ä»»åŠ¡ã€‚é€šè¿‡ `id` æ¥å¯¹åº”è¦å–æ¶ˆçš„åŠ¨ä½œã€‚å¯ä»¥ç±»æ¯”äºŽå®šæ—¶å™¨

```ts
import { createMachine, sendTo, cancel } from 'xstate';

const machine = createMachine({
  on: {
    event: {
      actions: sendTo(
        'someActor',             // ç›®æ ‡ actor
        { type: 'someEvent' },   // è¦å‘é€çš„äº‹ä»¶
        {
          id: 'someId',          // ç”¨äºŽ cancel çš„å”¯ä¸€æ ‡è¯†
          delay: 1000,           // å»¶è¿Ÿ 1 ç§’
        }
      ),
    },
    cancelEvent: {
      actions: cancel('someId'),  // å–æ¶ˆä¸Šé¢ id ä¸º someId çš„å»¶è¿Ÿäº‹ä»¶
    },
  },
});

```



### enqueueActions

actionsçš„æ‰§è¡Œé¡ºåºæ˜¯ç”±xstateå†³å®šçš„ï¼Œå¦‚æžœå¯¹actionsçš„æ‰§è¡Œé¡ºåºæœ‰å¼ºçƒˆçš„éœ€è¦å¯ä»¥ä½¿ç”¨`enqueueActions`ã€‚ç±»ä¼¼ä¸Žasync-awaitã€‚å‡½æ•°æ‰§è¡Œæ˜¯åŒæ­¥çš„ï¼Œä¸Šä¸€ä¸ªå‡½æ•°æ‰§è¡Œå®Œæˆä¸‹ä¸€ä¸ªå‡½æ•°æ‰ä¼šç»§ç»­æ‰§è¡Œã€‚

```ts
actions: [
  assign({ count: c => c + 1 }),
  'logCount',
]

```

```ts
enqueueActions(({ enqueue }) => {
  enqueue.assign(...)
  enqueue('logCount')
})

```

`enqueueActions` æ˜¯ **å”¯ä¸€å…è®¸ä½ â€œå‘½ä»¤å¼ä½¿ç”¨å†…ç½® actionsâ€çš„åœ°æ–¹**ï¼š

```ts
enqueue.assign(...)
enqueue.raise({ type: 'NEXT' })
enqueue.sendTo(...)
```



### examples

```ts
import { createMachine, assign, raise } from 'xstate';

const counterMachine = createMachine({
  id: 'counter',
  initial: 'active',
  context: {
    count: 0,
  },
  states: {
    active: {
      on: {
        INC: {
          actions: [
            // âœ… å†…ç½® actionï¼šæ›´æ–° context
            assign({
              count: ({ context }) => context.count + 1,
            }),

            // âœ… è‡ªå®šä¹‰ actionï¼šå‰¯ä½œç”¨ï¼ˆæ—¥å¿—ï¼‰
            ({ context }) => {
              console.log('å½“å‰ countï¼š', context.count + 1);
            },

            // âœ… å†…ç½® actionï¼šæ ¹æ®æ¡ä»¶è§¦å‘å†…éƒ¨äº‹ä»¶
            ({ context }) => {
              if (context.count + 1 >= 3) {
                // âŒ ä¸èƒ½ç›´æŽ¥ raise()
                // raise({ type: 'REACHED_MAX' })

                // âœ… æ­£ç¡®ï¼šè¿”å›ž built-in action
                return raise({ type: 'REACHED_MAX' });
              }
            },
          ],
        },

        REACHED_MAX: {
          target: 'done',
        },
      },
    },

    done: {
      entry: [
        // âœ… è‡ªå®šä¹‰ action
        () => {
          console.log('ðŸŽ‰ å·²è¾¾åˆ°æœ€å¤§å€¼');
        },
      ],
    },
  },
});

```

