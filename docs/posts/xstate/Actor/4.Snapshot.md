# Snapshot

## åŸºæœ¬æ¦‚å¿µ

å½“ä¸€ä¸ª actor æ¥æ”¶åˆ°äº‹ä»¶æ—¶ï¼Œå…¶å†…éƒ¨çŠ¶æ€å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚å½“çŠ¶æ€å‘ç”Ÿè½¬æ¢æ—¶ï¼Œactor å¯èƒ½ä¼šå‘å‡ºä¸€ä¸ªå¿«ç…§ã€‚ä½ å¯ä»¥é€šè¿‡ `actor.getSnapshot()` åŒæ­¥è¯»å– actor çš„å¿«ç…§ï¼Œæˆ–è€…é€šè¿‡ `actor.subscribe(observer)` è®¢é˜…å¿«ç…§ã€‚

## è·å–å¿«ç…§

### getSnapshot

```ts
import { fromPromise, createActor } from 'xstate';

async function fetchCount() {
  return Promise.resolve(42);
}

const countLogic = fromPromise(async () => {
  const count = await fetchCount();

  return count;
});

const countActor = createActor(countLogic);

countActor.start();

countActor.getSnapshot(); // logs undefined

// After the promise resolves...
countActor.getSnapshot();
// => {
//   output: 42,
//   status: 'done',
//   ...
// }
```

### subscribe

æ‚¨å¯ä»¥é€šè¿‡ `actor.subscribe(observer)` è®¢é˜…ä¸€ä¸ª actor çš„å¿«ç…§å€¼ã€‚å½“å¿«ç…§å€¼å‘å‡ºæ—¶ï¼Œè§‚å¯Ÿè€…å°†æ¥æ”¶è¯¥å€¼ã€‚è§‚å¯Ÿè€…å¯ä»¥æ˜¯ï¼š

- ä¸€ä¸ªæ¥æ”¶æœ€æ–°å¿«ç…§çš„æ™®é€šå‡½æ•°ï¼Œ
- ä¸€ä¸ªè§‚å¯Ÿè€…å¯¹è±¡ï¼Œå…¶ `.next(snapshot)` æ–¹æ³•æ¥æ”¶æœ€æ–°çš„å¿«ç…§
- ä½¿ç”¨ `error` å›è°ƒæ¥è®¢é˜… actor æŠ›å‡ºçš„é”™è¯¯ã€‚è¿™ä½¿æ‚¨èƒ½å¤Ÿå¤„ç†ç”± actor é€»è¾‘å‘å‡ºçš„é”™è¯¯ã€‚

```ts
// Observer as a plain function
const subscription = actor.subscribe((snapshot) => {
  console.log(snapshot);
});
```

```ts
// Observer as an object
const subscription = actor.subscribe({
  next(snapshot) {
    console.log(snapshot);
  },
  error(err) {
    // ...
  },
  complete() {
    // ...
  },
});
```

`actor.subscribe(observer)` çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªè®¢é˜…å¯¹è±¡ï¼Œå®ƒæœ‰ä¸€ä¸ª `.unsubscribe()` æ–¹æ³•ã€‚ä½ å¯ä»¥è°ƒç”¨ `subscription.unsubscribe()` æ¥å–æ¶ˆè®¢é˜…è§‚å¯Ÿè€…ï¼š

```ts
const subscription = actor.subscribe((snapshot) => {
  /* ... */
});

// Unsubscribe the observer
subscription.unsubscribe();
```

å½“ actor åœæ­¢æ—¶ï¼Œå…¶æ‰€æœ‰è§‚å¯Ÿè€…å°†è‡ªåŠ¨å–æ¶ˆè®¢é˜…ã€‚

## Snapshot Object

Snapshotå°±æ˜¯çŠ¶æ€æœºåœ¨æŸä¸€æ—¶åˆ»ï¼ˆå³æŸä¸ªStateï¼‰çš„â€œå®Œæ•´å¿«ç…§â€ã€‚å®ƒä¸æ˜¯åªæœ‰ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè€Œæ˜¯ä¸€ä¸ª**å¯¹è±¡**ï¼ŒåŒ…å«äº†ï¼š

```ts
{
  value,     // å½“å‰å¤„äºå“ªäº›çŠ¶æ€
  context,   // æ‰©å±•çŠ¶æ€ï¼ˆä¸šåŠ¡æ•°æ®ï¼‰
  _meta,      // çŠ¶æ€å…ƒä¿¡æ¯ï¼Œéœ€è¦é€šè¿‡getMetaè·å–
  children,  // å½“å‰æ´»è·ƒçš„å­ actor
  status,    // active | done | stopped
  output,     // ç»“æŸæ€è¾“å‡ºï¼ˆå¦‚æœæœ‰ï¼‰
  tags  //Set
}

```

snapshotæ˜¯ä¸€ä¸ªåªè¯»çš„ï¼Œå¯ä¿¡çš„UIçŠ¶æ€æº

### value

- ç®€å•çŠ¶æ€æœºï¼š

```ts
state.value === 'question'
```

- åµŒå¥—çŠ¶æ€æœº

```ts
state.value === { form: 'invalid' }
```

å½“å‰çŠ¶æ€æœºä¸­ï¼š

æ¿€æ´»äº†ä¸€ä¸ªçˆ¶çŠ¶æ€ **`form`**ï¼Œå¹¶ä¸”åœ¨ `form` é‡Œé¢ï¼Œæ¿€æ´»çš„å­çŠ¶æ€æ˜¯ **`invalid`**

```ts
createMachine({
  initial: 'form',
  states: {
    form: {
      initial: 'invalid',
      states: {
        invalid: {},
        valid: {},
      },
    },
  },
})

```

::: tip ä¸ºä»€ä¹ˆä¸æ˜¯ `'invalid'`ï¼Œè€Œæ˜¯ `{ form: 'invalid' }`ï¼Ÿ

å› ä¸º **XState ä¸ä¼šä¸¢å¤±â€œå±‚çº§ä¿¡æ¯â€**ã€‚

:::

- å¹¶è¡ŒçŠ¶æ€

æ¯ä¸ª key = ä¸€ä¸ªå¹¶è¡ŒåŒºåŸŸ

```ts
state.value ===
  {
    monitor: 'on',
    mode: 'dark',
  };
```

```ts
createMachine({
  type: 'parallel', // ğŸ‘ˆ å…³é”®
  states: {
    playback: {
      initial: 'paused',
      states: {
        paused: {},
        playing: {},
      },
    },
    volume: {
      initial: 'unmuted',
      states: {
        muted: {},
        unmuted: {},
      },
    },
  },
})
```

äº‹ä»¶å¦‚ä½•ä½œç”¨åœ¨å¹¶è¡ŒçŠ¶æ€ä¸Šï¼š

```ts
on: {
  PLAY: { target: '.playback.playing' },
  MUTE: { target: '.volume.muted' },
}
```



- null

State machines may also have no state nodes other than the root state node. For these state machines, the state value is `null`.

### status

| status    | å«ä¹‰                 |
| --------- | -------------------- |
| `active`  | æ­£åœ¨è¿è¡Œä¸­           |
| `done`    | å·²å®Œæˆï¼ˆè¿›å…¥ finalï¼‰ |
| `error`   | æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯   |
| `stopped` | è¢«æ‰‹åŠ¨åœæ­¢           |



### context

`state.context` è¡¨ç¤ºçš„æ˜¯å½“å‰çŠ¶æ€ä¸‹çš„ä¸Šä¸‹æ–‡ã€‚

```ts
const state = actor.getSnapshot()

state.context
// => { count: 0 }

```



```ts
createMachine({
  context: {
    count: 0,
  },
  initial: 'a',
  states: {
    a: {
      on: {
        NEXT: {
          target: 'b',
          actions: assign({
            count: ({ context }) => context.count + 1,
          }),
        },
      },
    },
    b: {
      entry: ({ context }) => {
        console.log(context.count)
      },
    },
  },
})

```

ä½ æ‹¿åˆ°çš„æ˜¯â€œå¿«ç…§ï¼ˆsnapshotï¼‰â€ï¼Œä¸æ˜¯â€œçŠ¶æ€æœ¬ä½“â€

```ts
const state = actor.getSnapshot()

/*
{
  value: ...,
  context: { count: 1 },
  ...
}
*/

```

è¿™ä¸ªå¯¹è±¡æ˜¯ï¼š

- âœ… å½“å‰æ—¶åˆ»çš„**åªè¯»å¿«ç…§**

- âŒ ä¸æ˜¯çŠ¶æ€æœºå†…éƒ¨æ­£åœ¨ç”¨çš„é‚£ä¸€ä»½

```ts
state.context.count++ // âŒ
```



### children

`state.children` æ˜¯â€œå½“å‰çŠ¶æ€æœºæ­£åœ¨è¿è¡Œçš„æ‰€æœ‰å­ actor çš„ç´¢å¼•è¡¨â€

key = actor id

value = ActorRef



### output

çŠ¶æ€æœºâ€œèµ°åˆ°æœ€ç»ˆå®Œæˆæ€ï¼ˆfinalï¼‰æ—¶â€ï¼Œå¯¹å¤–äº§å‡ºçš„ç»“æœã€‚

å¿…é¡» **åŒæ—¶æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶**ï¼š

1. çŠ¶æ€æœºåˆ°è¾¾ **é¡¶å±‚ final state**
2. final state å®šä¹‰äº† `output`

```ts
const machine = createMachine({
  initial: 'loading',
  states: {
    loading: {
      on: {
        DONE: 'success'
      }
    },
    success: {
      type: 'final',
      output: { ok: true }
    }
  }
})
```

```ts
const actor = createActor(machine).start()

actor.send({ type: 'DONE' })

const state = actor.getSnapshot()

state.status // 'done'
state.output // { ok: true }

```



## methods

### state.can(event)

```ts
state.can(event:EventObject)
```

- eventï¼šEventObjectã€‚äº‹ä»¶å¯¹è±¡

`state.can(event)` ç”¨æ¥åˆ¤æ–­ï¼šåœ¨â€œå½“å‰çŠ¶æ€ + å½“å‰ä¸Šä¸‹æ–‡â€ä¸‹ï¼Œå‘é€è¿™ä¸ªäº‹ä»¶ä¼šä¸ä¼šè§¦å‘ä¸€æ¬¡çŠ¶æ€è½¬æ¢ã€‚`state.can` ä¼šçœŸå®æ‰§è¡Œ guard

```ts
const machine = createMachine({
  context: { valid: false },
  initial: 'form',
  states: {
    form: {
      on: {
        SUBMIT: {
          target: 'success',
          guard: ({ context }) => context.valid
        }
      }
    },
    success: {}
  }
})

const actor = createActor(machine).start()
const state = actor.getSnapshot()

state.can({ type: 'SUBMIT' }) // falseï¼ˆguard ä¸é€šè¿‡ï¼‰

```

### state.hasTag(tag)

`state.hasTag(tag)` ç”¨æ¥åˆ¤æ–­ï¼šå½“å‰æ¿€æ´»çš„ä»»æ„çŠ¶æ€èŠ‚ç‚¹ï¼Œæ˜¯å¦æ‰“äº†æŸä¸ª tagã€‚

```ts
state.hasTag(tag:string)
```



### state.matches(value)

```ts
state.matches(value)
```

- valueï¼šStateValueã€‚çŠ¶æ€å€¼

`state.matches(...)` ç”¨æ¥åˆ¤æ–­ï¼šå½“å‰ `state.value` æ˜¯å¦â€œåŒ…å«â€ä½ ç»™å®šçš„çŠ¶æ€è·¯å¾„ã€‚åªè¦å½“å‰çŠ¶æ€â€œåŒ…å«â€ä½ ç»™çš„è·¯å¾„ï¼Œå°±ç®—åŒ¹é…

```ts
// state.value === 'question'
state.matches('question'); // true

// state.value === { form: 'invalid' }
state.matches('form'); // true
state.matches('question'); // false
state.matches({ form: 'invalid' }); // true
state.matches({ form: 'valid' }); // false

```


### state.getMeta()

`state.getMeta()` è¿”å›çš„æ˜¯ï¼šå½“å‰â€œæ‰€æœ‰æ¿€æ´»çŠ¶æ€èŠ‚ç‚¹â€çš„ meta ä¿¡æ¯é›†åˆã€‚ä¸æ˜¯æŸä¸€ä¸ª state çš„ metaï¼Œè€Œæ˜¯**æ•´æ£µæ¿€æ´»çŠ¶æ€æ ‘ä¸Šçš„ meta**ã€‚

- Returnï¼š`Record<string, any>`ï¼Œkeyï¼šçŠ¶æ€èŠ‚ç‚¹çš„å®Œæ•´ IDï¼ˆè·¯å¾„ï¼‰

```ts
const feedbackMachine = createMachine({
  id: 'feedback',
  // ...
  states: {
    form: {
      meta: {
        view: 'shortForm',
      },
    },
  },
});

const feedbackActor = createActor(feedbackMachine).start();

// Assume the current state is 'form'
const snapshot = feedbackActor.getSnapshot();
console.log(snapshot.getMeta());
// logs { 'feedback.form': { view:'shortForm' } }
```

## è¾…åŠ©å‡½æ•°

### waitFor

```ts
waitFor(actor, predicate, options?)
```

- actorï¼šActor
- predicateï¼šå›è°ƒå‡½æ•°`callback(snapshot)`
- optionsï¼š
  - timeoutï¼šè¶…æ—¶æ—¶é—´

ä½ å¯ä»¥ä½¿ç”¨ `waitFor` è¾…åŠ©å‡½æ•°ç­‰å¾…ä¸€ä¸ª actor çš„å¿«ç…§æ»¡è¶³æŸä¸ªè°“è¯æ¡ä»¶ã€‚`waitFor(...)` å‡½æ•°è¿”å›ä¸€ä¸ª promiseï¼Œè¯¥ promiseï¼š

- å½“å‘å‡ºçš„å¿«ç…§æ»¡è¶³ `predicate` å‡½æ•°æ—¶è§£æ
- å¦‚æœå½“å‰å¿«ç…§å·²ç»æ»¡è¶³ `predicate` å‡½æ•°ï¼Œåˆ™ç«‹å³è§£å†³
- å¦‚æœæŠ›å‡ºé”™è¯¯æˆ– `options.timeout` å€¼è¶…æ—¶ï¼Œåˆ™ä¼šè¢«æ‹’ç»ã€‚

```ts
import { waitFor } from 'xstate';
import { countActor } from './countActor.ts';

const snapshot = await waitFor(
  countActor,
  (snapshot) => {
    return snapshot.context.count >= 100;
  },
  {
    timeout: 10_000, // 10 seconds (10,000 milliseconds)
  },
);

console.log(snapshot.output);
// => 100
```

