# State machines

çŠ¶æ€æœºå°±æ˜¯ç”¨ä¸€ç§â€œå¯é¢„æµ‹ã€å¯æ¨å¯¼â€çš„æ–¹å¼ï¼Œæè¿°ä¸€ä¸ªä¸œè¥¿åœ¨ä¸åŒçŠ¶æ€ä¸‹ï¼Œé‡åˆ°ä¸åŒäº‹ä»¶ä¼šå‘ç”Ÿä»€ä¹ˆå˜åŒ–

## åˆ›å»º machines

```ts
import { createMachine } from 'xstate';

const feedbackMachine = createMachine({
  id: 'feedback',
  initial: 'question',
  states: {
    question: {
      on: {
        'feedback.good': {
          target: 'thanks',
        },
      },
    },
    thanks: {
      // ...
    },
    // ...
  },
});
```

â€œåœ¨ `question` çŠ¶æ€ä¸‹ï¼Œå¦‚æœæ”¶åˆ° `feedback.good` äº‹ä»¶ï¼Œå°±è·³åˆ° `thanks`â€

| æ¦‚å¿µ      | å«ä¹‰                                                         |
| --------- | ------------------------------------------------------------ |
| `initial` | åˆå§‹çŠ¶æ€                                                     |
| `states`  | æ‰€æœ‰å¯èƒ½çš„çŠ¶æ€                                               |
| `on`      | å½“å‰çŠ¶æ€èƒ½æ¥æ”¶çš„äº‹ä»¶ï¼ˆä¼šå‘ç”Ÿçš„äº‹ä»¶ï¼‰                         |
| `target`  | äº‹ä»¶å‘ç”Ÿåè·³è½¬åˆ°çš„çŠ¶æ€ï¼ˆäº‹ä»¶ä¸€æ—¦å‘ç”Ÿè¦ä¹ˆåœç•™åŸåœ°ï¼Œè¦ä¹ˆå¯¼è‡´çŠ¶æ€çš„æ›´æ”¹ï¼‰ |

## åˆ›å»º actor

Machine ä¸ä¼šè‡ªå·±è·‘ï¼Œè¦å˜æˆ Actor

```ts
const feedbackActor = createActor(feedbackMachine)//ç”¨è§„åˆ™è¯´æ˜ä¹¦ï¼Œåˆ›å»ºä¸€ä¸ªè¿è¡Œä¸­çš„å®ä¾‹

feedbackActor.start()//çŠ¶æ€ä» initial å¼€å§‹
feedbackActor.send({ type: 'feedback.good' })//å‘é€äº‹ä»¶ï¼Œæ¨åŠ¨çŠ¶æ€æµè½¬
```

| å¯¹æ¯”       | Machine  | Actor      |
| ---------- | -------- | ---------- |
| æ˜¯å¦è¿è¡Œ   | âŒ ä¸è¿è¡Œ | âœ… è¿è¡Œ     |
| æ˜¯å¦å¯å¤ç”¨ | âœ… å¯å¤ç”¨ | âŒ ä¸€æ¬¡å®ä¾‹ |
| èŒè´£       | æè¿°è§„åˆ™ | æ‰§è¡Œè§„åˆ™   |
| ç±»æ¯”       | ç±»å®šä¹‰   | ç±»å®ä¾‹     |



## ä¸ºä»€ä¹ˆè¦ç”¨çŠ¶æ€æœº

```ts
const step = ref(1)
const loading = ref(false)
const disabled = computed(() => step.value === 3 && loading.value)
```

å…¸å‹Vueç—›ç‚¹ï¼š

- çŠ¶æ€æ˜¯**éšå¼çš„**
- ç»„åˆä¸€å¤šå°±å¼€å§‹å¤±æ§
- å¾ˆéš¾å›ç­”ä¸€å¥è¯ï¼š**ç°åœ¨ç³»ç»Ÿåˆ°åº•å¤„äºä»€ä¹ˆçŠ¶æ€ï¼Ÿ**



## æä¾› implementations

> Providing implementations çš„æ ¸å¿ƒç›®çš„ï¼š æŠŠã€ŒçŠ¶æ€æœºçš„ç»“æ„ã€å’Œã€Œå…·ä½“æ‰§è¡Œä»£ç ã€å½»åº•åˆ†ç¦»

**implementations ä¸æ˜¯çŠ¶æ€æœºé€»è¾‘æœ¬èº«**ï¼Œè€Œæ˜¯ï¼š

**Actions**ï¼šå‰¯ä½œç”¨ï¼ˆæ‰“æ—¥å¿—ã€è¯·æ±‚æ¥å£ã€toastã€åŸ‹ç‚¹ï¼‰

**Actors**ï¼šå­ä»»åŠ¡ / å¼‚æ­¥é€»è¾‘ / å­çŠ¶æ€æœº

**Guards**ï¼šæ¡ä»¶åˆ¤æ–­ï¼ˆæ˜¯å¦å…è®¸è·³è½¬ï¼‰

**Delays**ï¼šå»¶è¿Ÿæ—¶é—´ï¼ˆafter / delayï¼‰

### å®ƒä»¬çš„å…±åŒç‰¹ç‚¹

- âŒ **ä¸å†³å®šçŠ¶æ€ç»“æ„**
- âŒ **ä¸å½±å“çŠ¶æ€ä¹‹é—´çš„å…³ç³»**
- âœ… **åªè´Ÿè´£â€œæ‰§è¡Œç»†èŠ‚â€**

ä¼ ç»Ÿå†™æ³•å…·æœ‰å¦‚ä¸‹ç¼ºç‚¹ï¼š

- é€»è¾‘å’Œå‰¯ä½œç”¨**æ··åœ¨ä¸€èµ·**
- ä¸å¥½æµ‹è¯•
- ä¸å¥½å¤ç”¨
- ä¸å¥½ mock

### setup

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨setupåˆ†ç¦»é€»è¾‘å’Œå®ç°ï¼š

```ts
import { setup } from 'xstate';

const feedbackMachine = setup({
  // Default implementations
  actions: {
    doSomething: () => {
      console.log('Doing something!');
    },
  },
  actors: {
    /* ... */
  },
  guards: {
    /* ... */
  },
  delays: {
    /* ... */
  },
}).createMachine({
  entry: { type: 'doSomething' },//å½“è¿›å…¥è¿™ä¸ªçŠ¶æ€æ—¶ï¼Œæ‰§è¡Œ setup.actions.doSomething
  // ... rest of machine config
});

const feedbackActor = createActor(feedbackMachine);

feedbackActor.start();
// logs 'Doing something!'

```

### provide

ä½ å¯ä»¥é‡å†™é»˜è®¤çš„implementationsï¼Œç”¨æ–°çš„ implementationsï¼Œç”Ÿæˆä¸€ä¸ªâ€œåŒç»“æ„çš„æ–° machineâ€ã€‚åŸ machine **å®Œå…¨ä¸å˜**ï¼Œè¿”å›çš„æ˜¯ **ä¸€ä¸ªæ–° machine**

```ts
const customFeedbackMachine = feedbackMachine.provide({
  actions: {
    doSomething: () => {
      console.log('Doing something else!');
    },
  },
});

const feedbackActor = createActor(customFeedbackMachine);

feedbackActor.start();
// logs 'Doing something else!'
```

::: tip ä½¿ç”¨åœºæ™¯

ä¸€ã€å¼€å‘ä¸æµ‹è¯•ç¯å¢ƒï¼š

```ts
// dev
machine.provide({
  actions: {
    log: console.log
  }
})

// prod
machine.provide({
  actions: {
    log: sendToSentry
  }
})

```

äºŒã€å•å…ƒæµ‹è¯•

```ts
const testMachine = machine.provide({
  actions: {
    submitForm: () => {
      // mockï¼Œä¸å‘è¯·æ±‚
    }
  }
})

```





:::

## ç±»å‹çº¦æŸ

```ts
const machineSetup = setup({
  types: {
    context: {} as { count: number; name: string },
    events: {} as
      | { type: 'increment'; value: number }
      | { type: 'reset' },
  },
})

```



```ts
actions: assign({
  count: ({ context }) => context.count + 1
})

```

The setup provides type-bound versions of all main built-in actions:

```ts
const incrementCount = machineSetup.assign({
  count: ({ context }) => context.count + 1,
})

```

## Transitioning state ï¼ˆçŠ¶æ€æ¨å¯¼ï¼‰

åœ¨ä¸å¯åŠ¨ actor çš„æƒ…å†µä¸‹ï¼Œçº¯è®¡ç®—â€œä¸‹ä¸€ä¸ªçŠ¶æ€ä¼šæ˜¯ä»€ä¹ˆâ€ã€‚è¿™æ˜¯ v5 **æ¨èä½¿ç”¨çš„æ–¹å¼**ï¼ˆæ›¿ä»£æ—§çš„ snapshot APIï¼‰

Transitioning state =ç»™å®šã€Œå½“å‰çŠ¶æ€ + ä¸€ä¸ªäº‹ä»¶ã€ï¼Œç›´æ¥ç®—å‡ºã€Œä¸‹ä¸€ä¸ªçŠ¶æ€ + ä¼šæ‰§è¡Œå“ªäº› actionsã€

è¿è¡ŒçŠ¶æ€æœºä¼šï¼š

- çœŸæ­£è¿è¡Œ
- ä¼šæ‰§è¡Œ actions
- ä¼šäº§ç”Ÿå‰¯ä½œç”¨

### ä½†æœ‰äº›åœºæ™¯ä½ ä¸æƒ³â€œè¿è¡Œâ€

æ¯”å¦‚ï¼š

- ğŸ” **è°ƒè¯• / å¯è§†åŒ–**
- ğŸ§ª **å•å…ƒæµ‹è¯•**
- ğŸ”„ **çŠ¶æ€å›æ”¾ / æ—¶é—´æ—…è¡Œ**
- ğŸ§  **æ ¹æ®è§„åˆ™â€œé¢„æµ‹â€ä¸‹ä¸€æ­¥**

è®¡ç®—åˆå§‹çŠ¶æ€ï¼š

```ts
const [initialState, initialActions] = initialTransition(machine)
```

- machineï¼šçŠ¶æ€æœº



è®¡ç®—ä¸€æ¬¡ transitionï¼š

```ts
const [nextState, actions] =transition(machine, state, event)
```

- machineï¼šçŠ¶æ€æœº
- stateï¼šçŠ¶æ€
- eventï¼šäº‹ä»¶

```ts
import { createMachine, initialTransition, transition } from 'xstate';

const machine = createMachine({
  initial: 'pending',
  states: {
    pending: {
      on: {
        start: { target: 'started' },
      },
    },
    started: {
      entry: 'doSomething',
    },
  },
});

const [initialState, initialActions] = initialTransition(machine);

console.log(initialState.value);
// logs 'pending'

console.log(initialActions);
// logs []

const [nextState, actions] = transition(machine, initialState, {
  type: 'start',
});

console.log(nextState.value);
// logs 'started'

console.log(actions);
// logs [{ type: 'doSomething', â€¦ }]
```



