# State machines

çŠ¶æ€æœºå°±æ˜¯ç”¨ä¸€ç§â€œå¯é¢„æµ‹ã€å¯æ¨å¯¼â€çš„æ–¹å¼ï¼Œæè¿°ä¸€ä¸ªä¸œè¥¿åœ¨ä¸åŒçŠ¶æ€ä¸‹ï¼Œé‡åˆ°ä¸åŒäº‹ä»¶ä¼šå‘ç”Ÿä»€ä¹ˆå˜åŒ–

## ä¸ºä»€ä¹ˆè¦ç”¨çŠ¶æ€æœº

```ts
const step = ref(1)
const loading = ref(false)
const disabled = computed(() => step.value === 3 && loading.value)
```

å…¸å‹Vueç—›ç‚¹ï¼š

- çŠ¶æ€æ˜¯**éšå¼çš„**
- ç»„åˆä¸€å¤šå°±å¼€å§‹å¤±æ§
- å¾ˆéš¾å›ç­”ä¸€å¥è¯ï¼š**ç°åœ¨ç³»ç»Ÿåˆ°åº•å¤„äºä»€ä¹ˆçŠ¶æ€ï¼Ÿ**



##

## åˆ›å»º machines

```ts
import { createMachine } from 'xstate';

const feedbackMachine = createMachine({
  id: 'feedback',
  initial: 'question',
  states: {
    question: {
      on: {
        'feedback.good': {
          target: 'thanks',
        },
      },
    },
    thanks: {
      // ...
    },
    // ...
  },
});
```

â€œåœ¨ `question` çŠ¶æ€ä¸‹ï¼Œå¦‚æœæ”¶åˆ° `feedback.good` äº‹ä»¶ï¼Œå°±è·³åˆ° `thanks`â€

| æ¦‚å¿µ      | å«ä¹‰                                                         |
| --------- | ------------------------------------------------------------ |
| `initial` | åˆå§‹çŠ¶æ€                                                     |
| `states`  | æ‰€æœ‰å¯èƒ½çš„çŠ¶æ€                                               |
| `on`      | å½“å‰çŠ¶æ€èƒ½æ¥æ”¶çš„äº‹ä»¶ï¼ˆä¼šå‘ç”Ÿçš„äº‹ä»¶ï¼‰                         |
| `target`  | äº‹ä»¶å‘ç”Ÿåè·³è½¬åˆ°çš„çŠ¶æ€ï¼ˆäº‹ä»¶ä¸€æ—¦å‘ç”Ÿè¦ä¹ˆåœç•™åŸåœ°ï¼Œè¦ä¹ˆå¯¼è‡´çŠ¶æ€çš„æ›´æ”¹ï¼‰ |

## åˆ›å»º actor

Machine ä¸ä¼šè‡ªå·±è·‘ï¼Œè¦å˜æˆ Actor

```ts
const feedbackActor = createActor(feedbackMachine)//ç”¨è§„åˆ™è¯´æ˜ä¹¦ï¼Œåˆ›å»ºä¸€ä¸ªè¿è¡Œä¸­çš„å®ä¾‹

feedbackActor.start()//çŠ¶æ€ä» initial å¼€å§‹
feedbackActor.send({ type: 'feedback.good' })//å‘é€äº‹ä»¶ï¼Œæ¨åŠ¨çŠ¶æ€æµè½¬
```

| å¯¹æ¯”       | Machine  | Actor      |
| ---------- | -------- | ---------- |
| æ˜¯å¦è¿è¡Œ   | âŒ ä¸è¿è¡Œ | âœ… è¿è¡Œ     |
| æ˜¯å¦å¯å¤ç”¨ | âœ… å¯å¤ç”¨ | âŒ ä¸€æ¬¡å®ä¾‹ |
| èŒè´£       | æè¿°è§„åˆ™ | æ‰§è¡Œè§„åˆ™   |
| ç±»æ¯”       | ç±»å®šä¹‰   | ç±»å®ä¾‹     |



## æä¾› implementations



## ç±»å‹çº¦æŸ

```ts
const machineSetup = setup({
  types: {
    context: {} as { count: number; name: string },
    events: {} as
      | { type: 'increment'; value: number }
      | { type: 'reset' },
  },
})

```



```ts
const incrementCount = machineSetup.assign({
  count: ({ context }) => context.count + 1,
})

```

## Transitioning state ï¼ˆçŠ¶æ€æ¨å¯¼ï¼‰

åœ¨ä¸å¯åŠ¨ actor çš„æƒ…å†µä¸‹ï¼Œçº¯è®¡ç®—â€œä¸‹ä¸€ä¸ªçŠ¶æ€ä¼šæ˜¯ä»€ä¹ˆâ€ã€‚è¿™æ˜¯ v5 **æ¨èä½¿ç”¨çš„æ–¹å¼**ï¼ˆæ›¿ä»£æ—§çš„ snapshot APIï¼‰

Transitioning state =ç»™å®šã€Œå½“å‰çŠ¶æ€ + ä¸€ä¸ªäº‹ä»¶ã€ï¼Œç›´æ¥ç®—å‡ºã€Œä¸‹ä¸€ä¸ªçŠ¶æ€ + ä¼šæ‰§è¡Œå“ªäº› actionsã€

è¿è¡ŒçŠ¶æ€æœºä¼šï¼š

- çœŸæ­£è¿è¡Œ
- ä¼šæ‰§è¡Œ actions
- ä¼šäº§ç”Ÿå‰¯ä½œç”¨

ä½†æœ‰äº›åœºæ™¯ä½ ä¸æƒ³â€œè¿è¡Œâ€ï¼Œæ¯”å¦‚ï¼š

- ğŸ” **è°ƒè¯• / å¯è§†åŒ–**
- ğŸ§ª **å•å…ƒæµ‹è¯•**
- ğŸ”„ **çŠ¶æ€å›æ”¾ / æ—¶é—´æ—…è¡Œ**
- ğŸ§  **æ ¹æ®è§„åˆ™â€œé¢„æµ‹â€ä¸‹ä¸€æ­¥**

è®¡ç®—åˆå§‹çŠ¶æ€ï¼š

```ts
const [initialState, initialActions] = initialTransition(machine)
```

- machineï¼šçŠ¶æ€æœº



è®¡ç®—ä¸€æ¬¡ transitionï¼š

```ts
const [nextState, actions] =transition(machine, state, event)
```

- machineï¼šçŠ¶æ€æœº
- stateï¼šçŠ¶æ€
- eventï¼šäº‹ä»¶
- returnï¼š
  - nextStateï¼šä¸‹ä¸€çŠ¶æ€çš„å¿«ç…§


```ts
import { createMachine, initialTransition, transition } from 'xstate';

const machine = createMachine({
  initial: 'pending',
  states: {
    pending: {
      on: {
        start: { target: 'started' },
      },
    },
    started: {
      entry: 'doSomething',
    },
  },
});

const [initialState, initialActions] = initialTransition(machine);

console.log(initialState.value);
// logs 'pending'

console.log(initialActions);
// logs []

const [nextState, actions] = transition(machine, initialState, {
  type: 'start',
});

console.log(nextState.value);
// logs 'started'

console.log(actions);
// logs [{ type: 'doSomething', â€¦ }]
```

## final

`type: 'final'` çš„çŠ¶æ€ï¼Œä¸èƒ½å†å†™ `target`ï¼Œä¹Ÿä¸ä¼šå†å‘ç”ŸçŠ¶æ€åˆ‡æ¢

ä¸€æ—¦è¿›å…¥ `final`ï¼š

- çŠ¶æ€æœº **ç«‹åˆ»å®Œæˆ**
- å‘çˆ¶çº§å‘é€ `done` äº‹ä»¶ï¼ˆå¦‚æœæœ‰çˆ¶ï¼‰
- å½“å‰çŠ¶æ€æœº **ç”Ÿå‘½å‘¨æœŸç»“æŸ**

## input

çŠ¶æ€æœºåœ¨è¢«actorä½¿ç”¨æ—¶ï¼Œå¯ä»¥æ¥æ”¶inputåˆå§‹åŒ–çŠ¶æ€æœºï¼Œè¿™ç±»æ¯”äºè°ƒç”¨å‡½æ•°ä¼ å…¥å½¢å‚

```ts
import { createActor, setup } from 'xstate';

const feedbackMachine = setup({
  types: {
    context: {} as {
      userId: string;
      feedback: string;
      rating: number;
    },
    input: {} as {
      userId: string;
      defaultRating: number;
    },
  },
}).createMachine({
  context: ({ input }) => ({
    userId: input.userId,
    feedback: '',
    rating: input.defaultRating,
  }),
  // ...
});

const feedbackActor = createActor(feedbackMachine, {
  input: {
    userId: '123',
    defaultRating: 5,
  },
});
```



## output

**âŒ å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œç”¨ `createMachine` å¾—åˆ°çš„ actorã€Œä¸éœ€è¦ outputã€**
 **âœ… åªæœ‰å½“å®ƒâ€œä½œä¸ºå­ actorï¼Œè¢«åˆ«äºº invoke / spawnï¼Œå¹¶ä¸”éœ€è¦æŠŠç»“æœäº¤å‡ºå»â€æ—¶ï¼Œæ‰æœ‰å¿…è¦å®šä¹‰ `output`**

```ts
success: {
  type: 'final',
  meta: { title: 'æˆåŠŸ' },
  output: ({ context }) => ({
    id: context.id,
  }),
}

```

`output` **ä»æ¥ä¸æ˜¯ç»™è‡ªå·±ç”¨çš„**ã€‚

```
const actor = createActor(machine)
```

- è¿™ä¸ª actor **è‡ªå·±æ‹¿ä¸åˆ° output**
- `output` **åªä¼šå‡ºç°åœ¨ `done` äº‹ä»¶é‡Œ**
- è€Œ `done` äº‹ä»¶ **æ˜¯å‘ç»™çˆ¶ actor çš„**

ğŸ‘‰ æ‰€ä»¥æœ¬è´¨æ˜¯ï¼š

> **output = actor å¯¹â€œå¤–éƒ¨ä¸–ç•Œâ€çš„è¿”å›å€¼**
